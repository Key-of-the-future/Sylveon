<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8">
    <title>Sylveon's trip :D</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style>
        body {
            margin: 0;
            background: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
        }

        canvas {
            image-rendering: pixelated;
        }
    </style>
</head>

<body>

<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
    scene: { preload, create, update }
};

var player;
var bombs;
var platforms;
var cursors;

let jumpCount = 0;
let maxJumps = 2;

let score = 0;
let highScore = 0;

let scoreText;
let highScoreText;

let gameOver = false;
let restartKey;

new Phaser.Game(config);

function preload ()
{
    this.load.image('bomba', 'assets/Estrellita.png');

    this.load.spritesheet('sylveon', 'assets/Sylveon.png', { frameWidth: 53 , frameHeight: 50 });
    this.load.spritesheet('sylveon_salto', 'assets/Sylveon_salto.png', { frameWidth: 50 , frameHeight: 50 });
    this.load.spritesheet('sylveon_salto_izquierda', 'assets/Sylveon_salto_izquierda.png', { frameWidth: 50 , frameHeight: 50 });
    this.load.spritesheet('sylveon_salto_derecha', 'assets/Sylveon_salto_derecha.png', { frameWidth: 50 , frameHeight: 50 });

    this.load.spritesheet('explosion', 'assets/explosion.png', { frameWidth: 30 , frameHeight: 28 });

    this.load.image('fondo', 'assets/Fondito.png');
    this.load.image('suelo', 'assets/Plataforma_Nubecita.png');
}

function create ()
{
    createAnims.call(this);

    this.add.image(400, 300, 'fondo');

    highScore = parseInt(localStorage.getItem('highScore')) || 0;

    scoreText = this.add.text(20, 20, 'Score: 0', { fontSize: '22px', fill: '#000' });
    highScoreText = this.add.text(20, 50, 'High Score: ' + highScore, { fontSize: '22px', fill: '#000' });

    platforms = this.physics.add.staticGroup();
    platforms.create(400, 568, 'suelo').setScale(2).refreshBody();
    platforms.create(600, 400, 'suelo').refreshBody();
    platforms.create(50, 250, 'suelo').refreshBody();
    platforms.create(750, 220, 'suelo').refreshBody();

    player = this.physics.add.sprite(100, 450, 'sylveon');
    player.setCollideWorldBounds(true);

    this.physics.add.collider(player, platforms);
    cursors = this.input.keyboard.createCursorKeys();

    bombs = this.physics.add.group({
        bounceX: 1,
        bounceY: 1,
        collideWorldBounds: true,
        allowGravity: true
    });

    for (let i = 0; i < 6; i++){
        let bomb = bombs.create(100 + i * 100, 0, 'bomba');
        bomb.setVelocity(Phaser.Math.Between(-120, 120), 200);
    }

    this.physics.add.collider(bombs, platforms);

    this.physics.add.overlap(player, bombs, explodeBomb, null, this);
}

function update ()
{
    if (gameOver) {
        if (Phaser.Input.Keyboard.JustDown(restartKey)) {
            this.scene.restart();
            gameOver = false;
        }
        return;
    }

    const onGround = player.body.blocked.down || player.body.touching.down;

    if (onGround) {
        jumpCount = 0;
    }

    if (cursors.left.isDown) {
        player.setVelocityX(-160);
        player.anims.play(onGround ? 'left' : 'jump_left', true);
    }
    else if (cursors.right.isDown) {
        player.setVelocityX(160);
        player.anims.play(onGround ? 'right' : 'jump_right', true);
    }
    else {
        player.setVelocityX(0);
        if (onGround) player.anims.play('turn');
    }

    if (Phaser.Input.Keyboard.JustDown(cursors.up)) {
        if (jumpCount < maxJumps) {
            player.setVelocityY(-330);
            jumpCount++;
            player.anims.play('jump');
        }
    }

    if (!onGround && player.body.velocity.y > 0) {
        player.anims.play('falling', true);
    }
}

function createAnims ()
{
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('sylveon', { start: 0, end: 3 }),
        frameRate: 10, repeat: -1
    });

    this.anims.create({
        key: 'turn',
        frames: [ { key: 'sylveon', frame: 4 } ],
        frameRate: 20
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('sylveon', { start: 5, end: 8 }),
        frameRate: 10, repeat: -1
    });

    this.anims.create({
        key: 'jump',
        frames: this.anims.generateFrameNumbers('sylveon_salto', { start: 0, end: 3 }),
        frameRate: 10
    });

    this.anims.create({
        key: 'jump_left',
        frames: this.anims.generateFrameNumbers('sylveon_salto_izquierda', { start: 0, end: 3 }),
        frameRate: 10
    });

    this.anims.create({
        key: 'jump_right',
        frames: this.anims.generateFrameNumbers('sylveon_salto_derecha', { start: 0, end: 3 }),
        frameRate: 10
    });

    this.anims.create({
        key: 'falling',
        frames: this.anims.generateFrameNumbers('sylveon_salto', { start: 0, end: 3 }),
        frameRate: 10
    });

    this.anims.create({
        key: 'explode',
        frames: this.anims.generateFrameNumbers('explosion', { start: 0, end: 7 }),
        frameRate: 20
    });
}

function explodeBomb(player, bomb)
{
    let boom = this.add.sprite(bomb.x, bomb.y, 'explosion');
    boom.play('explode');

    bomb.disableBody(true, true);
    player.disableBody(true, true);

    // Guardar high score
    if (score > highScore) {
        highScore = score;
        localStorage.setItem('highScore', highScore);
    }

    this.physics.pause();
    gameOver = true;

    let overlay = this.add.graphics();
    overlay.fillStyle(0x000000, 0.6);
    overlay.fillRect(0, 0, 800, 600);

    let text = this.add.text(400, 300,
        "GAME OVER\n\nHigh Score: " + highScore + "\nScore: " + score + "\n\nPress SPACE",
        { fontSize: "32px", fill: "#fff", align: "center" }
    ).setOrigin(0.5);

    restartKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
}

</script>

</body>
</html>
